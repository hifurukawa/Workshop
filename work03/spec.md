# 仕様メモ

## 1. 本ツールの定義

本ツールは、ローカル環境で動作する **CLI ベースの資格情報ストア**であり、
マスターパスワードによって保護されたサービス認証情報を安全に管理する。

本ツールは以下を目的とする。

- サービス名 × ユーザー名 に対応するパスワードの安全な保存
- CLI による明示的・再現可能な操作
- 業務利用を想定した堅牢なエラー処理と状態管理

---


## 2. 用語定義

- **資格情報（Credential）**
  - service, username, password 一式
- **マスターパスワード**
  - 本ツール全体を保護する単一の認証情報
- **初期化済み**
  - マスターパスワードが設定され、DB が利用可能な状態
---

## 3. 機能一覧

### 3.1 必須機能（MVP）

| 機能 | コマンド | マスター必須 |
|----|----|----|
| 初期化 | init | ○ |
| 登録 | add | ○ |
| 取得 | get | ○ |
| 削除 | del | ○ |
| 一覧 | list | × |
| エクスポート | export | ○ |
| インポート | import | ○ |
| マスター変更 | change-master | ○ |
| 状態表示 | status | × |
| ヘルプ | help | × |

### 3.2 拡張機能（今後の課題）
| 機能 | コマンド | マスター必須 |
|----|----|----|
| 編集 | update | ○ |
| 差分export | export　--diff | ○ |
| 差分import | export　--diff | ○ |
---

## 4. 仕様判断

※ [NOTE]: 判断理由やトレードオフなど
※ [memo]: 用語説明など調べたこと　

### 4.1 マスターパスワード管理

- マスターパスワードは復号を必要としないため、暗号化ではなくハッシュ化して保存する
  - ハッシュアルゴリズム：SHA-256
  - ソルト：初期化時にランダム生成
- 検証は「入力値＋ソルト → ハッシュ一致」で行う

>[NOTE]
ソルト付きハッシュを採用し、
DB 漏洩時における即時的なパスワード特定を防ぐことを目的とした。
ペッパーの利用も検討したが、
ローカル CLI ツールでは、
DB が盗まれるような状況で
ペッパーも同時に漏洩する可能性が高いため、本ツールでは採用しなかった。
<br>
また、本来マスターパスワードの保存にはストレッチングを用いるべきだが、
本ツールはローカル環境での
単一ユーザー利用を前提とした　CLI であり、オンライン攻撃や大規模な総当たり攻撃の脅威は低い。
そのため設計を単純化し、
SHA-256 + ソルト によるハッシュ化を採用した。


### 4.2 資格情報の保存形式・暗号化対象

- password カラムは **マスターパスワード由来の鍵で暗号化**する
- 暗号方式：AES-256-GCM（Node.js 標準 crypto 使用）
- list コマンドでは password を復号しない
- service および username は、検索・一覧表示・ソートの要件から平文で保存する

>[NOTE]
資格情報の password は取得時に復号が必要なため、
不可逆なハッシュではなく共通鍵暗号を用いて保護する。
<br>
暗号方式には Node.js 標準の crypto で安全に利用可能であり、
暗号化と同時に改ざん検知を行える AES-256-GCM を採用した。
<br>
暗号化・複合化に使用する鍵は、
マスターパスワードから 256bit の鍵を導出し（導出関数にはNode.js標準のPBKDF2を使用）直接利用しないことで安全性を確保する。
<br>
マスターパスワード変更時は、
旧マスターパスワードから導出した鍵で
すべての暗号化データを一度復号し、
新しいマスターパスワードから導出した鍵で再暗号化する。



### 4.3 DB スキーマ


```sql
credentials (
  service TEXT NOT NULL,
  username TEXT NOT NULL,
  password TEXT NOT NULL,
  PRIMARY KEY (service, username)
  -- サービス名 × ユーザー名で、1 つのパスワードを保存する
)

master (
  id INTEGER PRIMARY KEY CHECK (id = 1),
  -- マスターパスワードは、常に 1 つだけ存在する
  password_hash TEXT NOT NULL,
  salt TEXT NOT NULL,
  -- salt　は、認証用と鍵導出の両方で用いる
)
```

>[NOTE]
>- credentials.passwordカラムに入るのは、
base64(iv + tag + encrypted)の文字列
>- master.password_hashに入るのは、
[PBKDF2(マスターパスワード) + salt] のハッシュ値
※PBKDF2は鍵を生成する関数


>[memo]
>- iv : 初期化ベクトル（initialization vector) 
　→　暗号化プロセスの開始時に使用されるランダムな値
>- tag: 認証タグ
  → データが改ざんされていないことを確認するために使用する
>- encrypted : 暗号化したパスワード
>- base64 : データを64種類の文字（英大文字A-Z、小文字a-z、数字0-9、プラス+、スラッシュ/）を用いてテキストで表現するデータ変換方法


> [NOTE]
> salt の用途として、
> マスターパスワード検証用のハッシュ計算と
暗号鍵導出（KDF）に同一の salt を使用する。
本来は、認証用途と鍵導出用途で
salt を分離する設計も考えられるが、
本ツールはローカル環境・単一ユーザー利用を前提とし、
オンライン攻撃や大規模な総当たり攻撃を想定しない。
そのため、salt 管理を単純化した設計とした。
なお、将来的に脅威モデルが変化した場合には、
認証用 salt と鍵導出用 salt を分離する。

>[NOTE]
運用の注意事項として
ソルトは秘密情報ではないが、
失われた場合、既存データの復旧は不可能。
そのため、DB 全体を一体としてバックアップする必要がある。


### 4.4 トランザクション境界

- 状態を変更する各 CLI コマンドを
1 トランザクション単位として扱う

- コマンド内で発生する DB 更新は、
すべてトランザクション内で実行する

- DB 更新中にエラーが発生した場合は
全体をロールバックする

- 引数検証・マスターパスワード検証・
ファイル存在確認などの事前検証は、
トランザクション開始前に実行する



## 5. コマンド別仕様
### 5.1 共通:マスターパスワード入力仕様

マスターパスワードが必要なコマンドでは、
オプション引数にマスターパスワードが無い場合、
コマンド実行後に対話的にパスワード入力を要求する。

- 入力は標準入力（stdin）から受け取る
- 入力中は端末に文字を表示しない（非表示入力）
- 入力時には `EnterPassword:` と表示する


### 5.2 init
- 初期化済みの場合はエラー
- DB ファイルとスキーマを作成
- マスターパスワードを設定

### 5.3 add / get / del
- init 前は実行不可
- マスターパスワードが一致しない場合、状態変更は禁止
- add は (service, username) の一意制約を持つ
- get は stdout にパスワードを表示する

>[NOTE] 課題の必須要件を満たさないため破棄
~~get コマンドで表示されるパスワードは、
人間が一時的に確認することのみを目的とした情報であるため、
他コマンドへのパイプやファイル保存など、
機械的な再利用を防ぐ目的でstderrに表示する~~

>[memo]
※ stdout : パイプによって次のコマンドに渡される正常なデータ(機械処理前提の情報)
※ stderr : 常に端末画面に表示される情報（人間が読み取る前提の情報）


### 5.4 list
- マスターパスワード不要
- 出力項目は service, username のみ
- ソート指定がない場合：
  - service 昇順 → username 昇順

>[NOTE]
list コマンドは登録情報の探索を主目的とするため、ソート指定がない場合は service 昇順とした。

### 5.5 export/import

- マスターパスワードは入力直後に検証を行う。
- マスターパスワード不一致の場合は処理を開始せず、
ファイル生成・DB 更新などの副作用は発生させない
- CSV フォーマットは export 可能な形式のみをサポートする
- 改行・タブ文字などの制御文字を含めることはできない
- 文字コードは UTF-8 とする
>[NOTE]
CSV は 同一ツールのバックアップ・復元用途と位置づけ、Excel 編集や汎用 CSV との互換性は対象外とする。
そのため、CSV import は本ツールが export した形式のみをサポートする。
制御文字などが検出された場合、
不正形式として import を失敗させる。
ただし、最終行の空行だけは許容する。
<br>
CSV import は一括状態更新操作とし、
一件でも不正な行が存在した場合は
全体を失敗としてロールバックする仕様とする。

>[NOTE]
export時に既に同名ファイルがあった場合は,
上書きか、ファイル名変更か、キャンセルかをユーザに選択させる。
import時に既存データがある場合は
処理続行かキャンセルかをユーザに選択させる。


### 5.6 change-master
マスターパスワード変更時は、以下の手順で既存資格情報を再暗号化する。
1. 旧マスターパスワードを用いて暗号鍵を導出する。
2. 既存の資格情報をすべて復号し、平文をメモリ上に保持する。
3. 新マスターパスワードから新しい暗号鍵を導出する。
4. 平文データを新しい暗号鍵で再暗号化し、DB に保存する。

ただし、同一マスターパスワードが入力された場合は、再暗号化しない

>[NOTE]
規定オプションで旧マスターパスワードまたは新マスターパスワードの入力がなかった場合、
コマンド実行後に対話的にパスワード入力を要求する。
change-master の中で行う処理は以下の通り。
<br>
1. old master を取得（オプション or 対話）
2. new master を取得（オプション or 対話）
3. new master の再入力確認
4. old master の検証
5. new master の更新（既存資格情報を再暗号化を含む）
<br>
3 を 4 より前に行う理由は、
失敗が確定している処理で DB に触れないようにするため。


## 6. CSV フォーマット
```csv
service,username,password
gmail,user1,pass1
github,user2,pass2
```
- ヘッダ必須
- 空行・エスケープはサポートしない

## 7. 終了コード
- 0: 正常終了
- 1: 一般的な失敗（想定外エラー）
- 2: 引数・使い方エラー
- 3: 認証エラー
- 4: I/O・DB エラー

>[memo]
※　I/Oエラー：プログラム外部のリソースへのアクセスに失敗した際に発生するエラー

>[NOTE]
各コマンドは、
必須引数の不足・過剰、未知のオプション、形式不正を検出した場合、処理を開始せずエラーとして終了する。
この場合、DB 変更・ファイル生成・認証処理などの副作用は発生しない。
引数不正などのエラー発生時には、
エラー簡潔な説明を stderr に出力する。
>[NOTE]
エラーメッセージはCLIツールらしく英語表記とした。
理由付けするなら、文字化けのリスクを回避するため。

## 8.　ログ
>[NOTE]
>時間的制約により、ログ出力機能は未実装。
>本ツールの入力データ量、稼働時間は多くないことを考慮し
>ログ出力機能は優先度低と判断した。

### 8.1 出力内容
通常操作においてログ出力を行わない。

ただし、以下の場合にはログを出力する。

- I/O・DB エラー
- 暗号処理エラー
- 想定外エラー

ログには、以下を含める。
- エラー発生時刻
- 実行コマンド
- エラー種別
- 内部エラーメッセージ
- スタックトレース（想定外エラーのみ）

マスターパスワードや復号後のパスワードなど、
秘密情報を含めてはならない。

### 8.2 ログレベル
ログレベルは ERROR を基本とする。
WARN は処理継続可能な部分的異常にのみ使用する。
INFO / DEBUG は出力しない。

### 8.3 ログローテーション
短時間実行のCLIであり、ログ出力頻度が低いため
ログローテーションは行わない。



## 9. 非対応事項（仕様外）

- パスワード強度チェック
>[NOTE]
強度基準は主観的であるため、
強度判断は利用者責任とする。

- 同時実行制御
>[NOTE]
ローカル CLI を想定し、
単一ユーザーによる逐次実行を前提としているため、同時実行制御は仕様外とした。

- CSV の柔軟なパース
>[NOTE]
CSVをバックアップ用途と位置づけているため、export 可能な形式のみを対象とし、柔軟な CSV パースは仕様外とした。



## 10. help/status の出力形式
**[help]**
```
If --master is not specified,
the master password will be requested
interactively after execution.

node pwman.mts init [--master <masterPassword>]

node pwman.mts add <service> <username> <password> [--master <masterPassword>]

node pwman.mts get <service> <username> [--master <masterPassword>]

node pwman.mts del <service> <username> [--master <masterPassword>]

node pwman.mts list [--asc service|username] [--desc service|username]

node pwman.mts export <csvFilePath> [--master <masterPassword>]

node pwman.mts import <csvFilePath> [--master <masterPassword>]

node pwman.mts change-master [--old-master <oldMasterPassword>] [--new-master <newMasterPassword>]


node pwman.mts status

node pwman.mts help
```

**[status]**
```
Database: ./pwman.db
Total credentials: 5
```
---


## 11. その他メモ
- init は強制killであっても再実行を許さないか
- 「壊れたDB」はどう検知するか
- マスターパスワード未登録状態をどう扱うか

**▪️初期化済とは**：
- masterテーブルが存在する
- レコードが1件だけ存在する
  
**▪️DBが壊れているかを検知する方法**
1. 物理破損（SQLiteファイル破損）
→起動時にPRAGMA integrity_check;

1. スキーマ不整合
→PRAGMA table_info(master)で構造確認。

1. 論理的不整合（masterがない、複数ある等）
→SELECT COUNT(*) FROM master;
0件 → 未初期化
1件 → 正常
2件以上 → 壊れている

**▪️マスターパスワード未登録状態の場合は**
- masterが0件 → 未初期化状態 →initのみ許可
- それ以外のコマンドは：「DB未初期化」

**▪️起動時チェック**：
1. DB存在？
なし → 未初期化

2. SQLiteファイル破損チェック（integrity_check） OK？
NO → 異常終了

3. masterレコード数
0 → 未初期化
1 → 正常
2以上 → 異常終了

**▪️initの仕様**：
- 未初期化状態でのみ実行可能
- トランザクション必須
- 原子的に作成

**▪️DB状態定義**
- NO_DB：DB存在なし
- UNINITIALIZED：masterと- credentialsテーブルが両方無し
- READY : masterとcredentialsテーブルが両方存在
- CORRUPTED：
  - SQLiteファイル破損
  - masterレコード数が複数


**▪️状態遷移**
```mermaid
stateDiagram-v2
    [*] --> NO_DB

    NO_DB --> UNINITIALIZED : DBファイル作成
    UNINITIALIZED --> READY : init成功（master=1件）

    READY --> CORRUPTED : DB破損 / テーブル不整合
    UNINITIALIZED --> CORRUPTED : 途中失敗 / 片方テーブルのみ存在

    CORRUPTED --> NO_DB : DB削除
    CORRUPTED --> UNINITIALIZED : 修復成功（整合性回復）

    READY --> READY : 通常操作（add/get/del）
  ```